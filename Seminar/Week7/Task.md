# Изгубеният код: Загадката на разписанията

Петър беше сигурен, че тази седмица ще има упражнение по обектно-ориентирано програмиране. Въпреки това, в последния момент получи съобщение: "Колеги, днес няма да имаме упражнение, тъй като съм в Пловдив. Ще ви кача едно видео след малко, от което да изгледате последната част, както и още задачи, които да решавате. Другата седмица продължаваме."

Студентите започнаха да си пишат в групата – някои вече пътуваха към университета, други търсеха свободна зала, а трети просто се чудеха защо отново има хаос в разписанието. Накрая решиха да отменят сбирката – трима души не бяха достатъчни, за да се проведе ефективно упражнение.

Но защо отново разписанието не съвпадаше с реалността?

## Загадъчните изчезвания и дублирания

Мария, която се отличаваше с организираността си, беше все по-раздразнена от честите промени. Тя реши да се заеме с проблема и привлече Борис и Ивайла — съответно най-добрите в програмирането и анализа.

"Забелязвам нещо странно," каза Мария, докато разглеждаше историята на съобщенията в групата. "Всеки път, когато има отменено занятие, предишния ден е имало някаква промяна в системата."

Борис се замисли. "А знаете ли, че университетът наскоро въведе нова система за разписания? Чувал съм, че е доста сложна."

"Да, но какво общо има това с нашите отменени часове?" попита Ивайла.

"Може би повече, отколкото предполагаме," отговори Борис. "Системата е пълна с първични данни, които се наследяват и комбинират по странни начини."

## Навлизане в тайните на системата

С малко повече разследване, тримата успяха да се сдобият с достъп до кода на разписанията благодарение на един от асистентите, който им имаше доверие. Това, което откриха, ги смая.

"Вижте това," посочи Борис с изненада. "Системата всъщност използва композиция от обекти, за да представи всяко занятие. Но има нещо странно с начина, по който се създават и унищожават тези обекти."

Мария се вгледа в кода и веднага забеляза проблема!

```cpp
class Session {
private:
    std::string name;
    Student* attendees[30];
    int attendeeCount;
    Instructor* instructor;
    Room* location;
    Time duration;
public:
    Session() : attendeeCount(0) {}

    ~Session() {
        for (int i = 0; i < attendeeCount; i++) {
            delete attendees[i];
        }
    }

    bool operator==(const Session& other) const {
        return name == other.name && instructor == other.instructor;
    }

    void addAttendee(Student* student) {
        if (attendeeCount < 30) {
            attendees[attendeeCount++] = student;
        }
    }

    void removeAttendee(Student* student) {
        for (int i = 0; i < attendeeCount; i++) {
            if (attendees[i] == student) {
                for (int j = i; j < attendeeCount - 1; j++) {
                    attendees[j] = attendees[j + 1];
                }
                attendeeCount--;
                break;
            }
        }
    }
};
```

"Ето!" възкликна тя. "Виждате ли? Когато системата се опитва да сравни две занятия, тя проверява само името и преподавателя, но не и времето или залата!"

## Верижна реакция от грешки

Ивайла, която имаше опит с големи системи, бързо забеляза други проблеми.

"И това не е всичко," добави тя. "Погледнете как системата зарежда информацията от файловете."

```cpp
template<typename T>
bool load(std::string filename) {
    std::ifstream file(filename);
    if (!file) return false;

    T object;
    try {
        file >> object;
    } catch (...) {
        return false;
    }

    return true;
}
```

"Никакъв контрол на грешките!" възкликна Борис. "Ако файлът е повреден или ако форматът не съвпада, системата просто продължава, сякаш всичко е наред."

Мария поклати глава с разбиране. "И погледнете тук - итераторът, който всъщност обхожда разписанието и уведомява студентите:"

```cpp
class SessionIterator {
    Session* sessions[50];
    int current;
    int total;
public:
    SessionIterator() : current(0), total(0) {}

    void next() { if (current < total) current++; }
    bool isEnd() { return current == total; }
    void notify() {
        if (sessions[current]->instructor->isInTown()) {
            // Send confirmation
        } else {
            // Notify about cancellation
        }
    }
};
```

## Отстраняване на проблема

Въоръжени с това знание, тримата студенти набързо написаха подробен анализ на проблемите и предложение за решение, което включваше:

1. Правилна дефиниция на `Session` с всички необходими полета и правилно освобождаване на ресурси.
2. Шаблонна функция `template<typename T> bool available(const T& object)` за проверка на наличността.
3. Пълен жизнен цикъл на обектите с правилни конструктори, деструктори и копиращи оператори.
4. Подобрена система за работа с файлове, която проверява грешки и невалидни данни.
5. Изцяло преработен итератор, който коректно уведомява за всички промени, включително отмените.

> Погледнете [Skeleton.cpp](./Skeleton.cpp) и допълнете правилно структурата, за да бъде работеща. Допълнете с ваши методи и функционалности, ако сметнете за нужно (дори да са допълнителни за условието)

Когато завършиха, те изпратиха своите предложения на администратора на системата с надежда, че ще бъдат взети предвид.

## Неочакван обрат

Седмица по-късно, тримата получиха благодарствено писмо от ректора и покана да се присъединят към екипа за разработка на университетските системи. Оказа се, че проблемът е бил много по-сериозен, отколкото предполагали - той е засягал не само техните занятия, но и изпитните сесии и записванията за следващия семестър.

"Понякога решенията са пред очите ни," каза Мария, докато празнуваха в любимото си кафене. "Важното е да погледнеш проблема от правилния ъгъл."

Борис кимна замислено: "Точно както в програмирането - когато една структура не е дефинирана правилно, цялата система се срива. Не става въпрос само за код, а за начина, по който нещата се свързват помежду си."

"И за това как управляваме жизнения им цикъл," добави Ивайла. "От създаването до унищожаването."

Тримата се спогледаха с усмивка. Понякога за да разбереш как работи реалният свят, трябва да разбираш принципите, по които е създаден.

А студентите вече можеха да разчитат на своите разписания, без да очакват изненади в последния момент.
